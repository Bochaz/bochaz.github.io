<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dividir Gastos de Viaje</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 24px #0001;
      padding: 28px;
      position: relative;
    }
    h1, h2 { color: #0057b8; }
    label { font-weight: 600; display: block; margin-top: 10px; }
    input, select, textarea, button, .select-trip {
      margin-top: 5px;
      width: 100%;
      padding: 8px;
      border: 1px solid #b3c6e0;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 1em;
    }
    button, .btn {
      background: #0057b8;
      color: #fff;
      font-weight: bold;
      margin-top: 18px;
      cursor: pointer;
      border: none;
      transition: background 0.2s;
      border-radius: 5px;
      padding: 9px 0;
      font-size: 1em;
    }
    button:hover, .btn:hover { background: #003d82; }
    .delete-btn {
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 3px;
      padding: 2px 8px;
      margin-left: 8px;
      cursor: pointer;
    }
    .tabs {
      display: flex;
      margin-bottom: 18px;
      border-bottom: 2px solid #b3c6e0;
      overflow-x: auto;
      scrollbar-width: thin;
      -ms-overflow-style: none;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab {
      padding: 10px 22px;
      cursor: pointer;
      background: #eaf1f8;
      border-radius: 6px 6px 0 0;
      margin-right: 5px;
      font-weight: bold;
      color: #0057b8;
      border: 1px solid #b3c6e0;
      border-bottom: none;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    .tab.active {
      background: #fff;
      color: #003d82;
      border-bottom: 2px solid #fff;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .list {
      margin-top: 12px;
    }
    .expense, .person {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #eaf1f8;
      border-radius: 5px;
      margin: 6px 0;
      padding: 8px 12px;
      box-shadow: 0 1px 3px #00000008;
    }
    .balances {
      background: #f0f8e7;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
    }
    .balances .debt { color: #d32f2f; }
    .balances .credit { color: #388e3c; }
    .summary {
      background: #f5f5f5;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
    }
    .stats {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin: 12px 0;
    }
    .stat-card {
      background: #eaf1f8;
      border-radius: 8px;
      padding: 12px 16px;
      min-width: 160px;
      box-shadow: 0 1px 3px #00000008;
      flex: 1 1 200px;
    }
    .filter-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .filter-bar input, .filter-bar select {
      width: auto;
      min-width: 120px;
      flex: 1 1 120px;
    }
    .trip-header {
      position: absolute;
      top: 28px;
      right: 28px;
      text-align: right;
      z-index: 2;
    }
    .trip-current {
      font-size: 2em;
      font-weight: bold;
      color: #0057b8;
      cursor: pointer;
      margin-bottom: 2px;
    }
    .trip-menu {
      display: none;
      position: absolute;
      top: 48px;
      right: 0;
      background: #fff;
      border: 1px solid #b3c6e0;
      border-radius: 6px;
      box-shadow: 0 2px 12px #0002;
      padding: 12px;
      z-index: 3;
      min-width: 220px;
    }
    .trip-header.open .trip-menu { display: block; }
    .share-btn {
      position: absolute;
      top: 28px;
      right: 170px;
      background: #43a047;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 9px 14px;
      font-size: 1.1em;
      cursor: pointer;
      margin-top: 0;
      z-index: 2;
    }
    .icon-comida { color: #fbc02d; }
    .icon-transporte { color: #1976d2; }
    .icon-alojamiento { color: #43a047; }
    .icon-entretenimiento { color: #e53935; }
    .icon-otros { color: #757575; }
    .split-percent {
      display: flex;
      gap: 4px;
      align-items: center;
      margin-top: 4px;
    }
    .split-percent input {
      width: 60px;
      margin-right: 8px;
    }
    @media (max-width: 900px) {
      .container { padding: 8px; }
      .expense, .person, .stat-card { flex-direction: column; align-items: stretch; }
      .filter-bar { flex-direction: column; }
      .trip-header { top: 8px; right: 8px; }
      .share-btn { top: 8px; right: 100px; }
      .tabs { flex-wrap: nowrap; }
      .tab { flex-shrink: 0; }
    }
  </style>
</head>
<body>
<div class="container" id="mainContainer">
  <!-- Bot√≥n Compartir Enlace -->
  <button class="share-btn" id="copyLinkBtn" title="Compartir enlace">
    <span class="material-icons" style="vertical-align:middle;font-size:20px;">share</span> Compartir
  </button>
  <!-- Viaje actual (arriba a la derecha) -->
  <div class="trip-header" id="tripHeader">
    <div class="trip-current" id="tripCurrent">Viaje 1</div>
    <div class="trip-menu" id="tripMenu">
      <input type="text" id="tripNameInput" placeholder="Nombre del viaje" style="width:100%;margin-bottom:6px;">
      <button id="addTripBtn" class="btn" style="width:100%;"><span class="material-icons" style="vertical-align:middle;font-size:18px;">add</span> Crear viaje</button>
    </div>
  </div>

  <h1><span class="material-icons" style="vertical-align:middle;font-size:32px;">account_balance_wallet</span> Dividir Gastos de Viaje</h1>
  <div class="tabs" id="tabs">
    <div class="tab active" onclick="openTab('viajeros')">1. Viajeros</div>
    <div class="tab" onclick="openTab('gastos')">2. Gastos</div>
    <div class="tab" onclick="openTab('balances')">3. Balances</div>
    <div class="tab" onclick="openTab('historial')">4. Historial</div>
    <div class="tab" onclick="openTab('stats')">5. Estad√≠sticas</div>
    <!-- Flecha para scroll (solo en m√≥vil) -->
    <div class="tab" id="tabArrow" style="background:#fff;color:#0057b8;cursor:pointer;display:none;" title="Ver m√°s pesta√±as">
      <span class="material-icons">chevron_right</span>
    </div>
  </div>

  <!-- Pesta√±a 1: Viajeros -->
  <div id="tab-viajeros" class="tab-content active">
    <h2>Viajeros</h2>
    <label for="personName">Nombre:</label>
    <input type="text" id="personName" placeholder="Nombre del viajero">
    <button id="addPersonBtn">Agregar Viajero</button>
    <div class="list" id="personList"></div>
  </div>

  <!-- Pesta√±a 2: Gastos -->
  <div id="tab-gastos" class="tab-content">
    <h2>Registrar Gasto</h2>
    <label for="expenseDescription">Descripci√≥n (opcional):</label>
    <input type="text" id="expenseDescription" placeholder="Ej: Almuerzo, Gasolina, etc.">
    <label for="expenseCategory">Categor√≠a:</label>
    <select id="expenseCategory">
      <option value="Comida">üçΩÔ∏è Comida</option>
      <option value="Transporte">üöó Transporte</option>
      <option value="Alojamiento">üõèÔ∏è Alojamiento</option>
      <option value="Entretenimiento">üéÆ Entretenimiento</option>
      <option value="Otros">üíµ Otros</option>
    </select>
    <label for="expenseAmount">Monto ($):</label>
    <input type="number" id="expenseAmount" min="0" step="0.01" placeholder="0.00">
    <label for="expensePayer">Pagado por:</label>
    <select id="expensePayer"></select>
    <label>Repartido entre:</label>
    <div id="expenseSplit"></div>
    <div style="margin-top:4px;">
      <label><input type="checkbox" id="splitPercentCheck"> Repartir por porcentajes</label>
      <div id="splitPercentDiv" style="display:none;margin-top:8px;"></div>
    </div>
    <button id="addExpenseBtn">Agregar Gasto</button>
    <div class="list" id="expenseList"></div>
  </div>

  <!-- Pesta√±a 3: Balances -->
  <div id="tab-balances" class="tab-content">
    <h2>Balances</h2>
    <button id="calcBalancesBtn">Calcular Balances</button>
    <div id="balancesSection"></div>
  </div>

  <!-- Pesta√±a 4: Historial -->
  <div id="tab-historial" class="tab-content">
    <h2>Historial de Gastos</h2>
    <div class="filter-bar">
      <input type="text" id="filterDescription" placeholder="Buscar descripci√≥n">
      <select id="filterCategory">
        <option value="">Todas las categor√≠as</option>
        <option value="Comida">üçΩÔ∏è Comida</option>
        <option value="Transporte">üöó Transporte</option>
        <option value="Alojamiento">üõèÔ∏è Alojamiento</option>
        <option value="Entretenimiento">üéÆ Entretenimiento</option>
        <option value="Otros">üíµ Otros</option>
      </select>
      <input type="date" id="filterDateStart" placeholder="Desde">
      <input type="date" id="filterDateEnd" placeholder="Hasta">
      <button id="filterBtn">Filtrar</button>
      <button id="clearFilterBtn">Limpiar</button>
    </div>
    <div class="list" id="historyList"></div>
  </div>

  <!-- Pesta√±a 5: Estad√≠sticas -->
  <div id="tab-stats" class="tab-content">
    <h2>Estad√≠sticas</h2>
    <div class="stats" id="statsCards"></div>
    <canvas id="statsChart" style="max-width:400px;max-height:220px;margin:0 auto;display:block;"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // --- Configuraci√≥n de JSONBin ---
  const JSONBIN_URL = "https://api.jsonbin.io/v3/b/68c0a0d6d0ea881f4077edab";
  const JSONBIN_MASTERKEY = ""; // Deja vac√≠o si no es privado

  // --- Estado global ---
  let people = [];
  let expenses = [];
  let trips = [];
  let currentTripId = null;

  // --- Elementos DOM ---
  const tripHeader = document.getElementById('tripHeader');
  const tripCurrent = document.getElementById('tripCurrent');
  const tripMenu = document.getElementById('tripMenu');
  const tripNameInput = document.getElementById('tripNameInput');
  const addTripBtn = document.getElementById('addTripBtn');
  const copyLinkBtn = document.getElementById('copyLinkBtn');
  const tabs = document.getElementById('tabs');
  const tabArrow = document.getElementById('tabArrow');
  const personNameInput = document.getElementById('personName');
  const addPersonBtn = document.getElementById('addPersonBtn');
  const personList = document.getElementById('personList');
  const expensePayerSelect = document.getElementById('expensePayer');
  const expenseSplitDiv = document.getElementById('expenseSplit');
  const splitPercentCheck = document.getElementById('splitPercentCheck');
  const splitPercentDiv = document.getElementById('splitPercentDiv');
  const expenseDescriptionInput = document.getElementById('expenseDescription');
  const expenseCategorySelect = document.getElementById('expenseCategory');
  const expenseAmountInput = document.getElementById('expenseAmount');
  const addExpenseBtn = document.getElementById('addExpenseBtn');
  const expenseList = document.getElementById('expenseList');
  const calcBalancesBtn = document.getElementById('calcBalancesBtn');
  const balancesSection = document.getElementById('balancesSection');
  const filterDescription = document.getElementById('filterDescription');
  const filterCategory = document.getElementById('filterCategory');
  const filterDateStart = document.getElementById('filterDateStart');
  const filterDateEnd = document.getElementById('filterDateEnd');
  const filterBtn = document.getElementById('filterBtn');
  const clearFilterBtn = document.getElementById('clearFilterBtn');
  const historyList = document.getElementById('historyList');
  const statsCards = document.getElementById('statsCards');
  const statsChartCtx = document.getElementById('statsChart').getContext('2d');
  let statsChart = null;
  let percentValues = {}; // {personId: porcentaje}

  // --- Pesta√±as ---
  function openTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    let idx = tabName==='viajeros'?1:tabName==='gastos'?2:tabName==='balances'?3:tabName==='historial'?4:5;
    tabs.querySelector(`.tab:nth-child(${idx})`).classList.add('active');
    // Scroll a la pesta√±a en m√≥viles
    if (window.innerWidth < 600) {
      tabs.scrollTo({left: (idx-1)*120, behavior: 'smooth'});
    }
  }

  // --- Flecha scroll en m√≥viles ---
  function showTabArrow() {
    if (window.innerWidth < 600) {
      tabArrow.style.display = 'block';
      tabArrow.onclick = () => {
        tabs.scrollBy({left: 160, behavior: 'smooth'});
      };
    } else {
      tabArrow.style.display = 'none';
    }
  }
  window.addEventListener('resize', showTabArrow);
  showTabArrow();

  // --- Funciones de persistencia (JSONBin) ---
  async function loadFromCloud() {
    try {
      const resp = await fetch(JSONBIN_URL + "/latest", {
        headers: { "X-Master-Key": JSONBIN_MASTERKEY }
      });
      if (!resp.ok) throw new Error('Error al cargar');
      const data = await resp.json();
      if (data.record && data.record.trips) {
        trips = data.record.trips;
      } else {
        trips = [{id: 1, name: "Viaje 1"}];
      }
      if (trips.length === 0) trips = [{id: 1, name: "Viaje 1"}];
      renderTrips();
      if (currentTripId === null) currentTripId = trips[0].id;
      selectTrip(currentTripId);
    } catch (e) {
      trips = [{id: 1, name: "Viaje 1"}];
      currentTripId = 1;
      renderTrips();
      selectTrip(currentTripId);
    }
  }
  async function saveToCloud() {
    try {
      await fetch(JSONBIN_URL, {
        method: 'PUT',
        headers: {
          "Content-Type": "application/json",
          "X-Master-Key": JSONBIN_MASTERKEY
        },
        body: JSON.stringify({ trips })
      });
    } catch (e) {
      alert('Error al guardar en la nube.');
    }
  }

  // --- Viajes ---
  function renderTrips() {
    tripCurrent.textContent = trips.find(t => t.id === currentTripId).name;
    tripMenu.innerHTML = `
      <input type="text" id="tripNameInput" placeholder="Nombre del viaje" style="width:100%;margin-bottom:6px;">
      <button id="addTripBtn" class="btn" style="width:100%;"><span class="material-icons" style="vertical-align:middle;font-size:18px;">add</span> Crear viaje</button>
    `;
    addTripBtn.addEventListener('click', addTrip);
  }
  function toggleTripMenu() {
    tripHeader.classList.toggle('open');
  }
  function addTrip() {
    const name = tripNameInput.value.trim();
    if (!name) return alert('Ingresa un nombre');
    if (trips.some(t => t.name === name)) return alert('Ese nombre ya existe');
    const id = trips.length ? Math.max(...trips.map(t => t.id)) + 1 : 1;
    trips.push({id, name});
    tripNameInput.value = '';
    currentTripId = id;
    renderTrips();
    saveToCloud();
    selectTrip(id);
    tripHeader.classList.remove('open');
  }
  function selectTrip(tripId) {
    currentTripId = tripId;
    tripCurrent.textContent = trips.find(t => t.id === tripId).name;
    tripHeader.classList.remove('open');
    const trip = trips.find(t => t.id === tripId);
    if (!trip) return;
    people = trip.people || [];
    expenses = trip.expenses || [];
    renderPeople();
    renderExpenses();
    renderBalances();
    renderHistory();
    renderStats();
  }
  window.removeTrip = function(id) {
    if (!confirm('¬øEliminar este viaje y todos sus datos?')) return;
    trips = trips.filter(t => t.id !== id);
    if (trips.length === 0) trips = [{id: 1, name: "Viaje 1"}];
    currentTripId = trips[0].id;
    renderTrips();
    saveToCloud();
    selectTrip(currentTripId);
  };
  // Click fuera del men√∫ para cerrar
  document.addEventListener('click', e => {
    if (!tripHeader.contains(e.target)) tripHeader.classList.remove('open');
  });

  // --- Gesti√≥n de Viajeros ---
  function renderPeople() {
    personList.innerHTML = '';
    people.forEach(person => {
      const div = document.createElement('div');
      div.className = 'person';
      div.innerHTML = `<span>${person.name}</span>
        <button class="delete-btn" onclick="removePerson(${person.id})">Eliminar</button>`;
      personList.appendChild(div);
    });
    renderExpenseForm();
    renderBalances();
    renderHistory();
    renderStats();
    saveTripToCloud();
  }
  function addPerson() {
    const name = personNameInput.value.trim();
    if (!name) return alert('Ingresa un nombre');
    if (people.some(p => p.name === name)) return alert('Ese nombre ya existe');
    const id = people.length ? Math.max(...people.map(p => p.id)) + 1 : 1;
    people.push({id, name});
    personNameInput.value = '';
    renderPeople();
  }
  window.removePerson = function(id) {
    if (!confirm('¬øEliminar este viajero? Tambi√©n se borrar√°n sus gastos.')) return;
    people = people.filter(p => p.id !== id);
    expenses = expenses.filter(e => e.payerId !== id && !e.split.some(s => s.personId === id));
    renderPeople();
    renderExpenses();
    renderBalances();
    renderHistory();
    renderStats();
    saveTripToCloud();
  };

  // --- Formulario de gastos (con porcentajes) ---
  function renderExpenseForm() {
    expensePayerSelect.innerHTML = '';
    people.forEach(person => {
      const opt = document.createElement('option');
      opt.value = person.id;
      opt.textContent = person.name;
      expensePayerSelect.appendChild(opt);
    });
    expenseSplitDiv.innerHTML = '';
    splitPercentDiv.innerHTML = '';
    people.forEach(person => {
      const label = document.createElement('label');
      label.innerHTML = `<input type="checkbox" value="${person.id}" checked> ${person.name}`;
      expenseSplitDiv.appendChild(label);

      const div = document.createElement('div');
      div.className = 'split-percent';
      div.innerHTML = `
        <input type="number" min="0" max="100" value="100" id="percent_${person.id}" style="width:60px;" disabled>
        <span style="color:#0057b8;font-size:0.95em;">${person.name}</span>
      `;
      splitPercentDiv.appendChild(div);
    });
    // Mostrar porcentajes si se marca
    splitPercentCheck.onchange = () => {
      splitPercentDiv.style.display = splitPercentCheck.checked ? 'block' : 'none';
      if (!splitPercentCheck.checked) {
        splitPercentDiv.querySelectorAll('input').forEach(i => i.disabled = true);
      } else {
        splitPercentDiv.querySelectorAll('input').forEach(i => i.disabled = false);
      }
    };
  }

  // --- Gesti√≥n de gastos (con porcentajes) ---
  function renderExpenses() {
    expenseList.innerHTML = '';
    expenses.forEach(exp => {
      const payer = people.find(p => p.id === exp.payerId);
      const splitList = exp.split.map(s => {
        const p = people.find(p => p.id === s.personId);
        return p ? `<b>${p.name}:</b> $${s.amount.toFixed(2)}` : '';
      }).join(', ');
      const date = exp.date ? new Date(exp.date).toLocaleString() : '';
      const div = document.createElement('div');
      div.className = 'expense';
      div.innerHTML = `
        <span>
          <b>${getIcon(exp.cat)} ${exp.desc ? exp.desc : '(sin descripci√≥n)'}</b> (${exp.cat})<br>
          <span style="font-size:0.95em">Pagado por: ${payer ? payer.name : ''}</span><br>
          <span style="font-size:0.9em">Repartido: ${splitList}</span><br>
          <span style="font-size:0.85em">${date}</span>
        </span>
        <button class="delete-btn" onclick="removeExpense(${exp.id})">Eliminar</button>
      `;
      expenseList.appendChild(div);
    });
  }
  function addExpense() {
    if (people.length < 2) return alert('Agrega al menos 2 viajeros');
    const desc = expenseDescriptionInput.value.trim();
    const cat = expenseCategorySelect.value;
    const amount = parseFloat(expenseAmountInput.value);
    if (isNaN(amount) || amount <= 0) return alert('Ingresa un monto v√°lido');
    const payerId = parseInt(expensePayerSelect.value);
    let split = Array.from(expenseSplitDiv.querySelectorAll('input[type=checkbox]:checked'))
      .map(cb => ({personId: parseInt(cb.value), amount: 0}));
    if (!split.length) return alert('Selecciona al menos un viajero para repartir');
    // Porcentajes
    if (splitPercentCheck.checked) {
      let totalPercent = 0;
      split.forEach(s => {
        const p = people.find(p => p.id === s.personId);
        const val = parseFloat(document.getElementById(`percent_${s.personId}`).value) || 0;
        percentValues[s.personId] = val;
        totalPercent += val;
      });
      if (Math.abs(totalPercent-100) > 0.1) return alert('La suma de porcentajes debe ser 100%');
      split.forEach(s => {
        s.amount = Math.round(amount * (percentValues[s.personId]/100) * 100)/100;
      });
      // Ajustar redondeo
      let totalSplit = split.reduce((a,b) => a+b.amount, 0);
      if (Math.abs(totalSplit - amount) > 0.01) {
        split[split.length-1].amount += (amount - totalSplit);
      }
    } else {
      // Igualitario
      const splitAmount = amount / split.length;
      split.forEach(s => s.amount = Math.round(splitAmount * 100) / 100);
      let totalSplit = split.reduce((a,b) => a+b.amount, 0);
      if (Math.abs(totalSplit - amount) > 0.01) {
        split[split.length-1].amount += (amount - totalSplit);
      }
    }
    const id = expenses.length ? Math.max(...expenses.map(e => e.id)) + 1 : 1;
    expenses.push({
      id, desc, cat, amount, payerId, split,
      date: new Date().toISOString()
    });
    expenseDescriptionInput.value = '';
    expenseAmountInput.value = '';
    splitPercentCheck.checked = false;
    splitPercentDiv.style.display = 'none';
    splitPercentDiv.querySelectorAll('input').forEach(i => i.disabled = true);
    Array.from(expenseSplitDiv.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = true);
    renderExpenses();
    renderBalances();
    renderHistory();
    renderStats();
    saveTripToCloud();
  }
  window.removeExpense = function(id) {
    expenses = expenses.filter(e => e.id !== id);
    renderExpenses();
    renderBalances();
    renderHistory();
    renderStats();
    saveTripToCloud();
  };

  // --- Balances: Qui√©n debe pagar a qui√©n ---
  function renderBalances() {
    balancesSection.innerHTML = '';
    if (people.length < 2) return;
    const paid = {};
    people.forEach(p => paid[p.id] = 0);
    expenses.forEach(exp => { paid[exp.payerId] += exp.amount; });
    const owes = {};
    people.forEach(p => owes[p.id] = 0);
    expenses.forEach(exp => { exp.split.forEach(s => owes[s.personId] += s.amount); });
    const net = {};
    people.forEach(p => net[p.id] = (paid[p.id] || 0) - (owes[p.id] || 0));
    let balancesDiv = document.createElement('div');
    balancesDiv.className = 'balances';
    balancesDiv.innerHTML = '<b>Balances por persona:</b><br>';
    people.forEach(p => {
      let balance = net[p.id];
      if (balance > 0)
        balancesDiv.innerHTML += `<span class="credit">${p.name}: +$${balance.toFixed(2)}</span><br>`;
      else if (balance < 0)
        balancesDiv.innerHTML += `<span class="debt">${p.name}: -$${(-balance).toFixed(2)}</span><br>`;
      else
        balancesDiv.innerHTML += `<span>${p.name}: $0.00</span><br>`;
    });
    balancesSection.appendChild(balancesDiv);
    // Simplificar pagos (minimizar transacciones)
    let debtors = people.map(p => ({
      id: p.id,
      name: p.name,
      debt: -net[p.id] > 0.01 ? -net[p.id] : 0
    })).filter(p => p.debt > 0);
    let creditors = people.map(p => ({
      id: p.id,
      name: p.name,
      credit: net[p.id] > 0.01 ? net[p.id] : 0
    })).filter(p => p.credit > 0);
    let payments = [];
    let i = 0, j = 0;
    while (i < debtors.length && j < creditors.length) {
      let d = debtors[i];
      let c = creditors[j];
      let amount = Math.min(d.debt, c.credit);
      if (amount > 0.01) {
        payments.push({ from: d, to: c, amount: Math.round(amount * 100) / 100 });
        d.debt -= amount;
        c.credit -= amount;
      }
      if (d.debt < 0.01) i++;
      if (c.credit < 0.01) j++;
    }
    if (payments.length) {
      let payDiv = document.createElement('div');
      payDiv.className = 'balances';
      payDiv.innerHTML = '<b>Transacciones para cuadrar (simplificadas):</b><br>';
      payments.forEach(p => {
        payDiv.innerHTML += `<b>${p.from.name}</b> paga <b>$${p.amount.toFixed(2)}</b> a <b>${p.to.name}</b><br>`;
      });
      balancesSection.appendChild(payDiv);
    }
  }

  // --- Historial y filtros ---
  function renderHistory(filters={}) {
    historyList.innerHTML = '';
    let filtered = expenses;
    if (filters.desc) filtered = filtered.filter(e => e.desc && e.desc.toLowerCase().includes(filters.desc.toLowerCase()));
    if (filters.cat) filtered = filtered.filter(e => e.cat === filters.cat);
    if (filters.start) filtered = filtered.filter(e => e.date && new Date(e.date) >= new Date(filters.start));
    if (filters.end) filtered = filtered.filter(e => e.date && new Date(e.date) <= new Date(filters.end));
    filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
    filtered.forEach(exp => {
      const payer = people.find(p => p.id === exp.payerId);
      const splitList = exp.split.map(s => {
        const p = people.find(p => p.id === s.personId);
        return p ? `<b>${p.name}:</b> $${s.amount.toFixed(2)}` : '';
      }).join(', ');
      const date = exp.date ? new Date(exp.date).toLocaleString() : '';
      const div = document.createElement('div');
      div.className = 'expense';
      div.innerHTML = `
        <span>
          <b>${getIcon(exp.cat)} ${exp.desc ? exp.desc : '(sin descripci√≥n)'}</b> (${exp.cat})<br>
          <span style="font-size:0.95em">Pagado por: ${payer ? payer.name : ''}</span><br>
          <span style="font-size:0.9em">Repartido: ${splitList}</span><br>
          <span style="font-size:0.85em">${date}</span>
        </span>
      `;
      historyList.appendChild(div);
    });
  }
  function filterHistory() {
    renderHistory({
      desc: filterDescription.value,
      cat: filterCategory.value,
      start: filterDateStart.value,
      end: filterDateEnd.value
    });
  }
  clearFilterBtn.onclick = () => {
    filterDescription.value = '';
    filterCategory.value = '';
    filterDateStart.value = '';
    filterDateEnd.value = '';
    renderHistory();
  };

  // --- Estad√≠sticas ---
  function renderStats() {
    statsCards.innerHTML = '';
    let catTotals = {};
    expenses.forEach(exp => {
      catTotals[exp.cat] = (catTotals[exp.cat] || 0) + exp.amount;
    });
    let personTotals = {};
    people.forEach(p => personTotals[p.id] = 0);
    expenses.forEach(exp => {
      personTotals[exp.payerId] += exp.amount;
      exp.split.forEach(s => personTotals[s.personId] += s.amount);
    });
    let totalGastos = expenses.reduce((a,e) => a+e.amount, 0);
    let card1 = document.createElement('div');
    card1.className = 'stat-card';
    card1.innerHTML = `<b>Total del viaje:</b><br>$${totalGastos.toFixed(2)}`;
    statsCards.appendChild(card1);
    let card2 = document.createElement('div');
    card2.className = 'stat-card';
    card2.innerHTML = `<b>Total de gastos:</b><br>${expenses.length}`;
    statsCards.appendChild(card2);
    let card3 = document.createElement('div');
    card3.className = 'stat-card';
    card3.innerHTML = `<b>Viajeros:</b><br>${people.length}`;
    statsCards.appendChild(card3);
    if (statsChart) statsChart.destroy();
    statsChart = new Chart(statsChartCtx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(catTotals),
        datasets: [{
          data: Object.values(catTotals),
          backgroundColor: ['#fbc02d','#1976d2','#43a047','#e53935','#757575']
        }]
      },
      options: { plugins: { legend: { position: 'bottom' } } }
    });
  }

  // --- Utilidades ---
  function getIcon(cat) {
    if (cat === 'Comida') return '<span class="material-icons icon-comida" title="Comida">restaurant</span>';
    if (cat === 'Transporte') return '<span class="material-icons icon-transporte" title="Transporte">directions_car</span>';
    if (cat === 'Alojamiento') return '<span class="material-icons icon-alojamiento" title="Alojamiento">hotel</span>';
    if (cat === 'Entretenimiento') return '<span class="material-icons icon-entretenimiento" title="Entretenimiento">sports_esports</span>';
    return '<span class="material-icons icon-otros" title="Otros">attach_money</span>';
  }
  function saveTripToCloud() {
    trips = trips.map(t => t.id === currentTripId ? {...t, people, expenses} : t);
    saveToCloud();
  }
  function copyLink() {
    const url = window.location.href.split('?')[0] + '?trip=' + currentTripId;
    navigator.clipboard.writeText(url);
    alert('¬°Enlace copiado! Comparte este enlace con tus amigos.');
  }
  function openTripMenu() {
    tripHeader.classList.add('open');
  }
  tripCurrent.onclick = openTripMenu;

  // --- Eventos ---
  addTripBtn.addEventListener('click', addTrip);
  tripNameInput.addEventListener('keydown', e => { if (e.key === 'Enter') addTrip(); });
  copyLinkBtn.addEventListener('click', copyLink);
  addPersonBtn.addEventListener('click', addPerson);
  personNameInput.addEventListener('keydown', e => { if (e.key === 'Enter') addPerson(); });
  addExpenseBtn.addEventListener('click', addExpense);
  expenseAmountInput.addEventListener('keydown', e => { if (e.key === 'Enter') addExpense(); });
  calcBalancesBtn.addEventListener('click', renderBalances);
  filterBtn.addEventListener('click', filterHistory);
  // Filtro por viaje en URL
  const urlParams = new URLSearchParams(window.location.search);
  const tripParam = parseInt(urlParams.get('trip'));
  if (tripParam) currentTripId = tripParam;

  // --- Inicializaci√≥n ---
  loadFromCloud();
</script>
</body>
</html>
