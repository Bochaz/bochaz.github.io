<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Dividir Gastos de Viaje</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 700px;
      margin: 20px auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px #0001;
      padding: 24px;
    }
    h1, h2 { color: #0057b8; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, select, textarea, button {
      margin-top: 5px;
      width: 100%;
      padding: 8px;
      border: 1px solid #b3c6e0;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background: #0057b8;
      color: #fff;
      font-weight: bold;
      margin-top: 18px;
      cursor: pointer;
      border: none;
      transition: background 0.2s;
    }
    button:hover { background: #003d82; }
    .delete-btn {
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 3px;
      padding: 2px 8px;
      margin-left: 8px;
      cursor: pointer;
    }
    .tabs {
      display: flex;
      margin-bottom: 18px;
      border-bottom: 2px solid #b3c6e0;
    }
    .tab {
      padding: 10px 22px;
      cursor: pointer;
      background: #eaf1f8;
      border-radius: 6px 6px 0 0;
      margin-right: 5px;
      font-weight: bold;
      color: #0057b8;
      border: 1px solid #b3c6e0;
      border-bottom: none;
      transition: background 0.2s;
    }
    .tab.active {
      background: #fff;
      color: #003d82;
      border-bottom: 2px solid #fff;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .list {
      margin-top: 12px;
    }
    .expense, .person {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #eaf1f8;
      border-radius: 5px;
      margin: 6px 0;
      padding: 8px 12px;
    }
    .balances {
      background: #f0f8e7;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
    }
    .balances .debt { color: #d32f2f; }
    .balances .credit { color: #388e3c; }
    .summary {
      background: #f5f5f5;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
    }
    @media (max-width: 600px) {
      .container { padding: 8px; }
      .expense, .person { flex-direction: column; align-items: stretch; }
      .tabs { flex-direction: column; }
      .tab { margin-bottom: 4px; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Dividir Gastos de Viaje</h1>
  <!-- Pestañas -->
  <div class="tabs" id="tabs">
    <div class="tab active" onclick="openTab('viajeros')">1. Viajeros</div>
    <div class="tab" onclick="openTab('gastos')">2. Gastos</div>
    <div class="tab" onclick="openTab('balances')">3. Balances</div>
  </div>

  <!-- Pestaña 1: Viajeros -->
  <div id="tab-viajeros" class="tab-content active">
    <h2>Viajeros</h2>
    <label for="personName">Nombre:</label>
    <input type="text" id="personName" placeholder="Nombre del viajero">
    <button id="addPersonBtn">Agregar Viajero</button>
    <div class="list" id="personList"></div>
  </div>

  <!-- Pestaña 2: Gastos -->
  <div id="tab-gastos" class="tab-content">
    <h2>Registrar Gasto</h2>
    <label for="expenseDescription">Descripción (opcional):</label>
    <input type="text" id="expenseDescription" placeholder="Ej: Almuerzo, Gasolina, etc.">
    <label for="expenseCategory">Categoría:</label>
    <select id="expenseCategory">
      <option value="Comida">Comida</option>
      <option value="Transporte">Transporte</option>
      <option value="Alojamiento">Alojamiento</option>
      <option value="Entretenimiento">Entretenimiento</option>
      <option value="Otros">Otros</option>
    </select>
    <label for="expenseAmount">Monto ($):</label>
    <input type="number" id="expenseAmount" min="0" step="0.01" placeholder="0.00">
    <label for="expensePayer">Pagado por:</label>
    <select id="expensePayer"></select>
    <label>Repartido entre:</label>
    <div id="expenseSplit"></div>
    <button id="addExpenseBtn">Agregar Gasto</button>
    <div class="list" id="expenseList"></div>
  </div>

  <!-- Pestaña 3: Balances -->
  <div id="tab-balances" class="tab-content">
    <h2>Balances</h2>
    <button id="calcBalancesBtn">Calcular Balances</button>
    <div id="balancesSection"></div>
  </div>
</div>

<script>
  // --- Estado global ---
  let people = [];
  let expenses = [];

  // --- Elementos DOM ---
  const tabs = document.getElementById('tabs');
  const personNameInput = document.getElementById('personName');
  const addPersonBtn = document.getElementById('addPersonBtn');
  const personList = document.getElementById('personList');
  const expensePayerSelect = document.getElementById('expensePayer');
  const expenseSplitDiv = document.getElementById('expenseSplit');
  const expenseDescriptionInput = document.getElementById('expenseDescription');
  const expenseCategorySelect = document.getElementById('expenseCategory');
  const expenseAmountInput = document.getElementById('expenseAmount');
  const addExpenseBtn = document.getElementById('addExpenseBtn');
  const expenseList = document.getElementById('expenseList');
  const calcBalancesBtn = document.getElementById('calcBalancesBtn');
  const balancesSection = document.getElementById('balancesSection');

  // --- Pestañas ---
  function openTab(tabName) {
    // Oculta todas
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    // Muestra la seleccionada
    document.getElementById('tab-' + tabName).classList.add('active');
    tabs.querySelector(`.tab:nth-child(${tabName==='viajeros'?1:tabName==='gastos'?2:3})`).classList.add('active');
  }

  // --- Funciones de persistencia ---
  function saveToStorage() {
    localStorage.setItem('travelSplitPeople', JSON.stringify(people));
    localStorage.setItem('travelSplitExpenses', JSON.stringify(expenses));
  }
  function loadFromStorage() {
    const storedPeople = localStorage.getItem('travelSplitPeople');
    const storedExpenses = localStorage.getItem('travelSplitExpenses');
    if (storedPeople) people = JSON.parse(storedPeople);
    if (storedExpenses) expenses = JSON.parse(storedExpenses);
    renderPeople();
    renderExpenses();
    renderExpenseForm();
  }
  function clearStorage() {
    localStorage.removeItem('travelSplitPeople');
    localStorage.removeItem('travelSplitExpenses');
  }

  // --- Gestión de Viajeros ---
  function renderPeople() {
    personList.innerHTML = '';
    people.forEach(person => {
      const div = document.createElement('div');
      div.className = 'person';
      div.innerHTML = `<span>${person.name}</span>
        <button class="delete-btn" onclick="removePerson(${person.id})">Eliminar</button>`;
      personList.appendChild(div);
    });
    renderExpenseForm();
    renderBalances();
    saveToStorage();
  }
  function addPerson() {
    const name = personNameInput.value.trim();
    if (!name) return alert('Ingresa un nombre');
    if (people.some(p => p.name === name)) return alert('Ese nombre ya existe');
    const id = people.length ? Math.max(...people.map(p => p.id)) + 1 : 1;
    people.push({id, name});
    personNameInput.value = '';
    renderPeople();
  }
  window.removePerson = function(id) {
    if (!confirm('¿Eliminar este viajero? También se borrarán sus gastos.')) return;
    people = people.filter(p => p.id !== id);
    expenses = expenses.filter(e => e.payerId !== id && !e.split.some(s => s.personId === id));
    renderPeople();
    renderExpenses();
    renderBalances();
    saveToStorage();
  };

  // --- Formulario de gastos ---
  function renderExpenseForm() {
    expensePayerSelect.innerHTML = '';
    people.forEach(person => {
      const opt = document.createElement('option');
      opt.value = person.id;
      opt.textContent = person.name;
      expensePayerSelect.appendChild(opt);
    });
    expenseSplitDiv.innerHTML = '';
    people.forEach(person => {
      const label = document.createElement('label');
      label.innerHTML = `<input type="checkbox" value="${person.id}" checked> ${person.name}`;
      expenseSplitDiv.appendChild(label);
    });
  }

  // --- Gestión de gastos ---
  function renderExpenses() {
    expenseList.innerHTML = '';
    expenses.forEach(exp => {
      const payer = people.find(p => p.id === exp.payerId);
      const splitList = exp.split.map(s => {
        const p = people.find(p => p.id === s.personId);
        return p ? `<b>${p.name}:</b> $${s.amount.toFixed(2)}` : '';
      }).join(', ');
      const div = document.createElement('div');
      div.className = 'expense';
      div.innerHTML = `
        <span>
          <b>${exp.desc ? exp.desc : '(sin descripción)'}</b> (${exp.cat})<br>
          <span style="font-size:0.95em">Pagado por: ${payer ? payer.name : ''}</span><br>
          <span style="font-size:0.9em">Repartido: ${splitList}</span>
        </span>
        <button class="delete-btn" onclick="removeExpense(${exp.id})">Eliminar</button>
      `;
      expenseList.appendChild(div);
    });
  }
  function addExpense() {
    if (people.length < 2) return alert('Agrega al menos 2 viajeros');
    const desc = expenseDescriptionInput.value.trim();
    const cat = expenseCategorySelect.value;
    const amount = parseFloat(expenseAmountInput.value);
    if (isNaN(amount) || amount <= 0) return alert('Ingresa un monto válido');
    const payerId = parseInt(expensePayerSelect.value);
    const split = Array.from(expenseSplitDiv.querySelectorAll('input[type=checkbox]:checked'))
      .map(cb => ({personId: parseInt(cb.value), amount: 0}));
    if (!split.length) return alert('Selecciona al menos un viajero para repartir');
    // Dividir el monto entre los seleccionados (igualmente)
    const splitAmount = amount / split.length;
    split.forEach(s => s.amount = Math.round(splitAmount * 100) / 100);
    // Ajustar redondeo (el último paga la diferencia)
    let totalSplit = split.reduce((a,b) => a+b.amount, 0);
    if (Math.abs(totalSplit - amount) > 0.01) {
      split[split.length-1].amount += (amount - totalSplit);
    }
    const id = expenses.length ? Math.max(...expenses.map(e => e.id)) + 1 : 1;
    expenses.push({id, desc, cat, amount, payerId, split});
    expenseDescriptionInput.value = '';
    expenseAmountInput.value = '';
    Array.from(expenseSplitDiv.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = true);
    renderExpenses();
    renderBalances();
    saveToStorage();
  }
  window.removeExpense = function(id) {
    expenses = expenses.filter(e => e.id !== id);
    renderExpenses();
    renderBalances();
    saveToStorage();
  };

  // --- Balances: Quién debe pagar a quién ---
  function renderBalances() {
    balancesSection.innerHTML = '';
    if (people.length < 2) return;

    // 1. Calcular cuánto ha pagado cada uno
    const paid = {};
    people.forEach(p => paid[p.id] = 0);
    expenses.forEach(exp => {
      paid[exp.payerId] += exp.amount;
    });
    // 2. Calcular cuánto debe pagar cada uno (según gastos)
    const owes = {};
    people.forEach(p => owes[p.id] = 0);
    expenses.forEach(exp => {
      exp.split.forEach(s => {
        owes[s.personId] += s.amount;
      });
    });

    // 3. Calcular balance neto (pagado - debe pagar)
    const net = {};
    people.forEach(p => net[p.id] = (paid[p.id] || 0) - (owes[p.id] || 0));
    // 4. Mostrar balance por persona
    let balancesDiv = document.createElement('div');
    balancesDiv.className = 'balances';
    balancesDiv.innerHTML = '<b>Balances por persona:</b><br>';
    people.forEach(p => {
      let balance = net[p.id];
      if (balance > 0)
        balancesDiv.innerHTML += `<span class="credit">${p.name}: +$${balance.toFixed(2)}</span><br>`;
      else if (balance < 0)
        balancesDiv.innerHTML += `<span class="debt">${p.name}: -$${(-balance).toFixed(2)}</span><br>`;
      else
        balancesDiv.innerHTML += `<span>${p.name}: $0.00</span><br>`;
    });
    balancesSection.appendChild(balancesDiv);

    // 5. Calcular pagos mínimos (quién paga a quién)
    let debtors = people.map(p => ({
      id: p.id,
      name: p.name,
      debt: -net[p.id] > 0.01 ? -net[p.id] : 0
    })).filter(p => p.debt > 0);
    let creditors = people.map(p => ({
      id: p.id,
      name: p.name,
      credit: net[p.id] > 0.01 ? net[p.id] : 0
    })).filter(p => p.credit > 0);

    let payments = [];
    let i = 0, j = 0;
    while (i < debtors.length && j < creditors.length) {
      let d = debtors[i];
      let c = creditors[j];
      let amount = Math.min(d.debt, c.credit);
      if (amount > 0.01) {
        payments.push({
          from: d,
          to: c,
          amount: Math.round(amount * 100) / 100
        });
        d.debt -= amount;
        c.credit -= amount;
      }
      if (d.debt < 0.01) i++;
      if (c.credit < 0.01) j++;
    }
    if (payments.length) {
      let payDiv = document.createElement('div');
      payDiv.className = 'balances';
      payDiv.innerHTML = '<b>Transacciones para cuadrar:</b><br>';
      payments.forEach(p => {
        payDiv.innerHTML += `<b>${p.from.name}</b> paga <b>$${p.amount.toFixed(2)}</b> a <b>${p.to.name}</b><br>`;
      });
      balancesSection.appendChild(payDiv);
    }
  }

  // --- Eventos ---
  addPersonBtn.addEventListener('click', addPerson);
  personNameInput.addEventListener('keydown', e => { if (e.key === 'Enter') addPerson(); });
  addExpenseBtn.addEventListener('click', addExpense);
  expenseAmountInput.addEventListener('keydown', e => { if (e.key === 'Enter') addExpense(); });
  calcBalancesBtn.addEventListener('click', renderBalances);

  // --- Inicialización ---
  loadFromStorage();

  <script>
  // --- Configuración de JSONBin ---
  const JSONBIN_URL = "https://api.jsonbin.io/v3/b/68c0662c43b1c97be93cc809"; // <-- TU BIN ID
  const JSONBIN_MASTERKEY = ""; // Si quieres proteger tu bin, crea una "Master Key" en jsonbin.io (opcional)
  // --- Funciones para guardar/cargar ---
  async function loadFromCloud() {
    try {
      const resp = await fetch(JSONBIN_URL + "/latest", {
        headers: { "X-Master-Key": JSONBIN_MASTERKEY }
      });
      if (!resp.ok) throw new Error('Error al cargar');
      const data = await resp.json();
      if (data.record && data.record.people && data.record.expenses) {
        people = data.record.people;
        expenses = data.record.expenses;
      }
      renderPeople();
      renderExpenses();
      renderBalances();
    } catch (e) {
      alert('No se pudo cargar desde la nube. Usando datos locales.');
      loadFromStorage();
    }
  }
  async function saveToCloud() {
    try {
      await fetch(JSONBIN_URL, {
        method: 'PUT',
        headers: {
          "Content-Type": "application/json",
          "X-Master-Key": JSONBIN_MASTERKEY
        },
        body: JSON.stringify({ people, expenses })
      });
    } catch (e) {
      alert('Error al guardar en la nube. Los datos se guardarán solo localmente.');
      saveToStorage();
    }
  }
  // --- Sustituir las funciones de persistencia ---
  // Busca y reemplaza: saveToStorage -> saveToCloud
  // Busca y reemplaza: loadFromStorage -> loadFromCloud
  // Llama a `loadFromCloud()` en lugar de `loadFromStorage()` al inicio
</script>

</body>
</html>

